javascript:(function(){  if(typeof DEBUG!=='boolean')DEBUG=false;  var ALLOWED_GAME_SCREENS=['info_player'];  function getParameterByName(name,url){    if(!url)url=window.location.href;    try{return new URL(url,window.location.href).searchParams.get(name);}catch(e){return null;}  }  function startProgressBar(total){    var width=jQuery('#contentContainer')[0].clientWidth;    var preloaderContent='<div id="progressbar" class="progress-bar" style="margin-bottom:12px;">'+'<span class="count label">0/'+total+'</span>'+'<div id="progress">'+'<span class="count label" style="width: '+width+'px;">0/'+total+'</span>'+'</div>'+'</div>';    jQuery('#contentContainer').eq(0).prepend(preloaderContent);  }  function updateProgressBar(index,total){    jQuery('#progress').css('width',(((index+1)/total)*100)+'%');    jQuery('.count').text('Fetching '+(index+1)+'/'+total);    if(index+1===total){jQuery('#progressbar').fadeOut(1000);}  }  function fetchAll(urls,onLoad,onDone,onError){    var numDone=0;    var lastRequestTime=0;    var minWaitTime=250;    function loadNext(){      if(numDone===urls.length){onDone();return;}      var now=Date.now();      var timeElapsed=now-lastRequestTime;      if(timeElapsed<minWaitTime){setTimeout(loadNext,minWaitTime-timeElapsed);return;}      lastRequestTime=now;      jQuery.get(urls[numDone]).done(function(data){        try{          onLoad(numDone,data);          numDone++;          loadNext();        }catch(e){onError(e);}      }).fail(function(xhr){onError(xhr);});    }    loadNext();  }  function parseTroopRow(row){    var sum=0;    jQuery(row).find('td').slice(1).each(function(){      var num=parseInt(jQuery(this).text().replace(/[^\d]/g,''),10);      if(isNaN(num))num=0;      sum+=num;    });    return sum;  }  function parseTWDate(dateStr,timeStr){    var now=new Date();    if(dateStr.toLowerCase()==="astăzi"){      var parts=timeStr.split(':');      return new Date(now.getFullYear(),now.getMonth(),now.getDate(),parseInt(parts[0],10),parseInt(parts[1],10),parseInt(parts[2],10));    } else if(dateStr.toLowerCase()==="ieri"){      var parts=timeStr.split(':');      return new Date(now.getFullYear(),now.getMonth(),now.getDate()-1,parseInt(parts[0],10),parseInt(parts[1],10),parseInt(parts[2],10));    } else {      var parts=dateStr.split('.');      if(parts.length!==3)return null;      var day=parseInt(parts[0],10),          month=parseInt(parts[1],10)-1,          year=parseInt(parts[2],10);      var timeParts=timeStr.split(':');      if(timeParts.length!==3)return null;      return new Date(year,month,day,parseInt(timeParts[0],10),parseInt(timeParts[1],10),parseInt(timeParts[2],10));    }  }  function initCategorizeVillages(){    if(!ALLOWED_GAME_SCREENS.includes(getParameterByName('screen'))){      UI.ErrorMessage('Script must be executed from Player Info screen!');      return;    }    var currentProfileName=(jQuery('#content_value h2 span').text().trim()||jQuery('#content_value h2').text().trim()).toLowerCase();    var villagesLinks=[];    jQuery('#villages_list td a').not('.ctx').each(function(){      villagesLinks.push(jQuery(this).attr('href'));    });    if(villagesLinks.length===0){      UI.InfoMessage('No villages found!');      return;    }    startProgressBar(villagesLinks.length);    UI.SuccessMessage('Fetching village notes...');    var villageData=[];    fetchAll(villagesLinks,function(index,data){      updateProgressBar(index,villagesLinks.length);      var htmlDoc=jQuery.parseHTML(data);      var villageName=jQuery(htmlDoc).find('#content_value h2').text().trim();      var villageCoords=jQuery(htmlDoc).find('#content_value > table > tbody > tr > td:nth-child(1) > table:nth-child(1) > tbody > tr:nth-child(3) > td:nth-child(2)').text().trim();      var category="No report on village";      var color="gray";      var notesContainer=jQuery(htmlDoc).find('.village-notes-container');      if(notesContainer.length>0){        var noteElements=notesContainer.find('.village-note').filter(function(){          return jQuery(this).css('display')!=='none';        });        var candidates=[];        noteElements.each(function(){          if(jQuery(this).find('.spoiler').find('table#attack_info_def').length>0){            var headText=jQuery(this).find('.village-note-head').text().toLowerCase();            var m=headText.match(/(?:pe\s*)?((?:\d{2}\.\d{2}\.\d{4})|ieri|astăzi)\s*la(?:\s*ora)?\s*(\d{2}:\d{2}:\d{2})/iu);            if(m){              var d=parseTWDate(m[1],m[2]);              if(d)candidates.push({note:jQuery(this),date:d});            }          }        });        if(candidates.length>0){          candidates.sort(function(a,b){            return b.date-a.date;          });          var validNote=candidates[0].note;          var defTable=validNote.find('.spoiler').find('table#attack_info_def');          if(defTable.length>0){            var defenderNameExtract=defTable.find('tr').first().find('th').eq(1).text().trim().toLowerCase();            if(defenderNameExtract===currentProfileName){              var numRow=defTable.find('tr').filter(function(){                return jQuery(this).find('td').first().text().trim().toLowerCase()==="număr:";              }).first();              var lostRow=defTable.find('tr').filter(function(){                return jQuery(this).find('td').first().text().trim().toLowerCase()==="pierderi:";              }).first();              if(numRow.length>0 && lostRow.length>0){                var totalTroops=parseTroopRow(numRow);                var lostTroops=parseTroopRow(lostRow);                var remainingTroops=totalTroops-lostTroops;                console.log("Village: "+villageName+", Total: "+totalTroops+", Lost: "+lostTroops+", Remaining: "+remainingTroops);                if(remainingTroops<500){                  category="Empty village";                  color="green";                } else if(remainingTroops<6000){                  category="Half village";                  color="orange";                } else if(remainingTroops<16000){                  category="1 full village";                  color="darkorange";                } else {                  category="Full village";                  color="red";                }              } else {                category="No report on village";                color="gray";              }            } else {              category="No report on village";              color="gray";            }          } else {            category="No report on village";            color="gray";          }        }        console.log("Final Category for "+villageName+": "+category);        villageData.push({name:villageName,coords:villageCoords,category:category});        var villageUrl=villagesLinks[index];        var villageId=getParameterByName('id',villageUrl);        var villageRow=jQuery('#villages_list a[href*="id='+villageId+'"]').closest('tr');        if(villageRow.length){          villageRow.find('td:last').append('<span style="margin-left: 5px; font-weight: bold; color: '+color+';">('+category+')</span>');        }      }    },function(){      displayVillageCategories(villageData);    },function(error){      UI.ErrorMessage('Error fetching village notes!');      console.error("Error:",error);    });  }  function displayVillageCategories(villages){    var groups={"Empty village":[],"Half village":[],"1 full village":[],"Full village":[],"No report on village":[]};    villages.forEach(function(v){      if(groups[v.category]){        groups[v.category].push(v.coords);      } else {        groups[v.category]=[v.coords];      }    });    var content='<div style="background-color: lightgreen; padding: 10px; margin-bottom: 10px;">';    for(var cat in groups){      var col;      switch(cat){        case "Empty village":          col="green";          break;        case "Half village":          col="orange";          break;        case "1 full village":          col="darkorange";          break;        case "Full village":          col="red";          break;        default:          col="gray";      }      content+='<p><b>'+cat+' ('+groups[cat].length+'): </b>'+'<span style="color:'+col+';">'+(groups[cat].join(' ')||'None')+'</span></p>';    }    content+='</div>';    jQuery("#content_value").prepend(content);  }  initCategorizeVillages();})();
